# Root Cause Analysis: Vercel Deployment Issue

## Problem
Changes work on localhost/ngrok but not on Vercel, even after pushing changes.

## Root Causes Identified

### 1. **Functions Config Issue** ‚ö†Ô∏è PRIMARY ISSUE
The `vercel.json` had:
```json
"functions": {
  "api/index.js": {
    "includeFiles": "api/index.js"
  }
}
```

**Problem**: This tells Vercel to use the committed `api/index.js` file directly from the repository, **instead of rebuilding it** during deployment.

**Solution**: Removed the `functions` config. Now Vercel will:
1. Run `npm run build:vercel` (which includes `npm run build:api`)
2. The build script regenerates `api/index.js` from TypeScript source
3. Vercel uses the freshly built file

### 2. **Branch Deployment** (Possible Issue)
You're on `dev` branch. Vercel might be:
- Only deploying from `main` branch
- Or using cached code from a previous `main` deployment

**Check**: Vercel Dashboard ‚Üí Settings ‚Üí Git ‚Üí Production Branch
- Should be set to `dev` if you want `dev` deployments
- Or merge `dev` ‚Üí `main` for production

### 3. **Build Process Order**
The build command runs:
```bash
npm run build:vercel
  ‚Üí npm run build (client)
  ‚Üí npm run build:api (regenerates api/index.js)
```

**Issue**: If `api/index.js` exists in the repo, Vercel might use it before the build completes.

**Solution**: The build script overwrites the file, but the `functions` config was preventing this.

## Fix Applied

1. ‚úÖ Removed `functions` config from `vercel.json`
2. ‚úÖ Build process will now regenerate `api/index.js` on every deploy
3. ‚úÖ Vercel will use the freshly built file, not the committed one

## Next Steps

1. **Commit the fix**:
   ```bash
   git add vercel.json
   git commit -m "Fix: Remove functions config to allow Vercel to rebuild api/index.js"
   git push
   ```

2. **Verify Vercel Build**:
   - Go to Vercel Dashboard ‚Üí Deployments ‚Üí Latest
   - Check Build Logs for:
     - `üì¶ Bundling API function with all server code...`
     - `‚úÖ Bundled to api/index.js`

3. **Test**:
   - After deployment completes, test Google Sheets connection
   - Should redirect to `/integrations` (not `/settings`)
   - Redirect URI mismatch should be fixed

## Why This Happens

Vercel's serverless functions work like this:
- If a file exists in `api/` folder, Vercel treats it as a serverless function
- The `functions` config with `includeFiles` tells Vercel to use that file as-is
- This bypasses the build process
- By removing it, Vercel will use the file generated by the build command

## Prevention

Going forward:
- ‚úÖ Edit TypeScript files in `server/api/`
- ‚úÖ Run `npm run build:api` locally to test
- ‚úÖ Commit both TypeScript source AND built `api/index.js`
- ‚úÖ Vercel will rebuild it anyway, but having it in git ensures it works if build fails
